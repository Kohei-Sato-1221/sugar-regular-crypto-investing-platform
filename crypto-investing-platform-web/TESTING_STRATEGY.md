# Next.js テスト戦略（松・竹・梅プラン）

## 概要

このドキュメントでは、工数の兼ね合いを考慮した3段階のテスト戦略を提案します。

## テストツール選定

### 推奨スタック
- **テストフレームワーク**: Vitest（Jestより高速、Next.jsとの統合が容易）
- **React Testing**: React Testing Library
- **tRPC Testing**: tRPC公式のテストヘルパー
- **E2E Testing**: Playwright（竹・松プランのみ）

---

## 🌸 梅プラン（最小限・1-2週間）

### 目標
- コア機能の動作確認
- 回帰テストの基盤構築
- 工数: **1-2週間**

### バックエンド（サーバーサイド）

#### 1. 認証ロジックのユニットテスト
```
src/server/auth/__tests__/
  ├── cognito.test.ts          # signIn, saveSession, getSession
  ├── token-utils.test.ts      # decodeIdToken, decodeAccessToken
  └── index.test.ts            # auth()関数
```

**テスト対象**:
- ✅ `signIn()` - 正常系・エラー系
- ✅ `saveSession()` - Cookie設定の確認
- ✅ `getSession()` - セッション取得・有効期限チェック
- ✅ `decodeIdToken()` - JWTデコード

**工数**: 3-4日

#### 2. tRPCルーターのユニットテスト
```
src/server/api/routers/__tests__/
  ├── auth.test.ts             # signIn, changePassword, signOut, getSession
  └── post.test.ts             # 既存のpostルーター
```

**テスト対象**:
- ✅ `auth.signIn` - 正常系・バリデーションエラー
- ✅ `auth.changePassword` - パスワード変更フロー
- ✅ `auth.getSession` - セッション取得

**工数**: 2-3日

### フロントエンド（クライアントサイド）

#### 1. ログインフォームのテスト
```
src/app/public/signin/__tests__/
  └── page.test.tsx
```

**テスト対象**:
- ✅ フォーム入力・バリデーション
- ✅ エラーメッセージ表示
- ✅ ログイン成功時のリダイレクト

**工数**: 2-3日

#### 2. 認証フローの統合テスト
```
src/__tests__/
  └── auth-flow.test.tsx       # ログイン→リダイレクト→セッション確認
```

**工数**: 1-2日

### 合計工数見積もり
- **バックエンド**: 5-7日
- **フロントエンド**: 3-5日
- **合計**: **8-12日（約1.5-2週間）**

---

## 🎋 竹プラン（標準・2-3週間）

### 目標
- 主要機能の網羅的テスト
- CI/CDパイプラインへの統合
- 工数: **2-3週間**

### バックエンド（サーバーサイド）

#### 梅プランの内容 + 以下を追加

#### 1. ミドルウェアのテスト
```
src/__tests__/
  └── middleware.test.ts        # 認証チェック、リダイレクト
```

**テスト対象**:
- ✅ 認証済みユーザーのアクセス許可
- ✅ 未認証ユーザーのリダイレクト
- ✅ Cookieの有効期限チェック

**工数**: 2日

#### 2. tRPCコンテキストのテスト
```
src/server/api/__tests__/
  └── trpc.test.ts             # createTRPCContext, セッション取得
```

**工数**: 1-2日

#### 3. エラーハンドリングのテスト
- Cognito APIエラーの処理
- ネットワークエラー
- タイムアウト処理

**工数**: 2-3日

### フロントエンド（クライアントサイド）

#### 梅プランの内容 + 以下を追加

#### 1. コンポーネントのテスト
```
src/app/_components/__tests__/
  └── post.test.tsx            # LatestPostコンポーネント
```

**工数**: 1-2日

#### 2. tRPCフックのテスト
```
src/trpc/__tests__/
  └── react.test.tsx           # api.useUtils, クエリキャッシュ
```

**工数**: 2日

#### 3. パスワード変更フローのテスト
```
src/app/public/change-password/__tests__/
  └── page.test.tsx
```

**工数**: 2日

#### 4. ルーティングのテスト
- 認証済みページへのアクセス
- 未認証時のリダイレクト
- callbackUrlの処理

**工数**: 2日

### E2Eテスト（基本）

#### 1. 認証フローのE2Eテスト
```
e2e/
  └── auth.spec.ts             # ログイン→パスワード変更→ログアウト
```

**テスト対象**:
- ✅ ログイン成功フロー
- ✅ パスワード変更フロー
- ✅ ログアウト

**工数**: 3-4日

### CI/CD統合
- GitHub Actionsでの自動テスト実行
- カバレッジレポート生成

**工数**: 1-2日

### 合計工数見積もり
- **バックエンド**: 10-14日
- **フロントエンド**: 9-12日
- **E2E**: 3-4日
- **CI/CD**: 1-2日
- **合計**: **23-32日（約3-4週間）**

---

## 🌲 松プラン（包括的・4-6週間）

### 目標
- 高カバレッジ（80%以上）
- パフォーマンステスト
- セキュリティテスト
- 工数: **4-6週間**

### バックエンド（サーバーサイド）

#### 竹プランの内容 + 以下を追加

#### 1. エッジケースのテスト
- トークン期限切れの処理
- リフレッシュトークンのローテーション
- 同時ログインの処理
- レート制限

**工数**: 3-4日

#### 2. パフォーマンステスト
- 認証処理の負荷テスト
- セッション取得のパフォーマンス
- メモリリークの検証

**工数**: 3-4日

#### 3. セキュリティテスト
- XSS対策
- CSRF対策
- トークン漏洩のシミュレーション
- ブルートフォース対策

**工数**: 4-5日

#### 4. モックとフィクスチャ
- Cognito APIのモック
- テストデータの管理
- ファクトリー関数

**工数**: 2-3日

### フロントエンド（クライアントサイド）

#### 竹プランの内容 + 以下を追加

#### 1. アクセシビリティテスト
- ARIA属性の確認
- キーボードナビゲーション
- スクリーンリーダー対応

**工数**: 3-4日

#### 2. パフォーマンステスト
- レンダリングパフォーマンス
- メモリ使用量
- バンドルサイズの最適化

**工数**: 2-3日

#### 3. ブラウザ互換性テスト
- Chrome, Firefox, Safari, Edge
- モバイルブラウザ

**工数**: 2-3日

#### 4. ビジュアルリグレッションテスト
- Chromatic または Percy
- UIコンポーネントのスナップショット

**工数**: 2-3日

### E2Eテスト（包括的）

#### 1. 全ユーザーフローのE2Eテスト
```
e2e/
  ├── auth.spec.ts             # 認証フロー
  ├── private-pages.spec.ts    # 認証済みページ
  ├── error-handling.spec.ts   # エラーハンドリング
  └── performance.spec.ts     # パフォーマンス
```

**工数**: 5-7日

### テストインフラ

#### 1. テスト環境の構築
- テスト用DBのセットアップ
- モックサーバーの構築
- テストデータの管理

**工数**: 3-4日

#### 2. カバレッジレポート
- カバレッジ目標の設定（80%以上）
- カバレッジレポートの可視化
- カバレッジゲートの設定

**工数**: 1-2日

#### 3. テストドキュメント
- テスト戦略の文書化
- テストケースの管理
- テスト実行ガイド

**工数**: 2-3日

### 合計工数見積もり
- **バックエンド**: 18-24日
- **フロントエンド**: 18-24日
- **E2E**: 5-7日
- **インフラ**: 6-9日
- **合計**: **47-64日（約6-8週間）**

---

## 推奨実装順序

### フェーズ1: 梅プラン（必須）
1. 認証ロジックのテスト（バックエンド）
2. ログインフォームのテスト（フロントエンド）
3. 基本的な統合テスト

### フェーズ2: 竹プラン（推奨）
1. ミドルウェアのテスト
2. コンポーネントのテスト
3. E2Eテスト（基本）
4. CI/CD統合

### フェーズ3: 松プラン（理想）
1. エッジケースのテスト
2. パフォーマンステスト
3. セキュリティテスト
4. ビジュアルリグレッションテスト

---

## テストツールのセットアップ

### 必要なパッケージ

```json
{
  "devDependencies": {
    "vitest": "^1.0.0",
    "@testing-library/react": "^14.0.0",
    "@testing-library/jest-dom": "^6.1.0",
    "@testing-library/user-event": "^14.5.0",
    "@trpc/server": "^11.0.0", // テスト用
    "@vitest/ui": "^1.0.0",
    "playwright": "^1.40.0", // 竹・松プランのみ
    "@playwright/test": "^1.40.0",
    "msw": "^2.0.0", // モック用
    "jsdom": "^23.0.0" // DOM環境
  }
}
```

### 設定ファイル例

#### `vitest.config.ts`
```typescript
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  test: {
    environment: 'jsdom',
    setupFiles: ['./src/__tests__/setup.ts'],
    globals: true,
  },
  resolve: {
    alias: {
      '~': path.resolve(__dirname, './src'),
    },
  },
});
```

---

## メンテナンスコスト

### 梅プラン
- **月次**: 2-4時間（テストの更新・修正）

### 竹プラン
- **月次**: 4-8時間（テストの更新・新機能への対応）

### 松プラン
- **月次**: 8-16時間（包括的なメンテナンス）

---

## 推奨

**現時点での推奨**: **竹プラン**

理由:
1. 梅プランでは不十分（認証機能は重要）
2. 松プランは過剰（初期段階では）
3. 竹プランで主要機能をカバーし、必要に応じて拡張可能

**段階的アプローチ**:
1. まず梅プランを実装（1-2週間）
2. その後、竹プランに拡張（追加1-2週間）
3. 必要に応じて松プランの要素を追加

